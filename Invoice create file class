CLASS zcl_uiwc_invoice_runner DEFINITION
  PUBLIC
  FINAL
  CREATE PUBLIC.

  PUBLIC SECTION.

    TYPES: BEGIN OF ty_params,
             inv_id     TYPE zuiwc_invoice-inv_id,
             inv_date   TYPE zuiwc_invoice-inv_date,

             test_run   TYPE abap_bool,
             do_post    TYPE abap_bool,
             do_output  TYPE abap_bool,

             out_print  TYPE abap_bool,
             out_email  TYPE abap_bool,
             print_form TYPE abap_bool,
             print_rep  TYPE abap_bool,

             email_prim TYPE abap_bool,
             email_all  TYPE abap_bool,
             att_rep    TYPE abap_bool,

             printer    TYPE pri_params-pdest,
             form_name  TYPE fpname,

             so_fund    TYPE RANGE OF zuiwc_gl_config-fund,
             so_agcy    TYPE RANGE OF zuiwc_invoice-agcy,
             so_prctr   TYPE RANGE OF zuiwc_invoice-prctr,
           END OF ty_params.

    METHODS constructor IMPORTING is_params TYPE ty_params.
    METHODS execute.

  PRIVATE SECTION.

    CONSTANTS:
      gc_glcat_payroll TYPE zuiwc_gl_config-category VALUE 'P',
      gc_doctype_dr    TYPE bapiache09-doc_type      VALUE 'DR',
      gc_ledger_0l     TYPE acdoca-rldnr             VALUE '0L',
      gc_rrcty_0       TYPE acdoca-rrcty             VALUE '0'.

    DATA ms_params TYPE ty_params.

    TYPES: BEGIN OF ty_agency,
             agcy      TYPE zuiwc_agency-agcy,
             prctr     TYPE zuiwc_agency-prctr,
             bp        TYPE zuiwc_agency-bp,
             agcy_fund TYPE zuiwc_agency-agcy_fund,
             agcy_ctr  TYPE zuiwc_agency-agcy_ctr,
             active    TYPE zuiwc_agency-active,
           END OF ty_agency.
    TYPES ty_t_agency TYPE STANDARD TABLE OF ty_agency WITH EMPTY KEY.

    TYPES: BEGIN OF ty_invoice_work,
             inv_id      TYPE zuiwc_invoice-inv_id,
             inv_date    TYPE zuiwc_invoice-inv_date,
             fund        TYPE zuiwc_gl_config-fund,

             agcy        TYPE zuiwc_invoice-agcy,
             prctr       TYPE zuiwc_invoice-prctr,

             contr_runid TYPE zuiwc_agcy_amnts-contr_run_id,
             contr_date  TYPE zuiwc_invoice-contr_date,
             contr_rate  TYPE zuiwc_invoice-contr_rate,

             payr_qtr    TYPE zuiwc_invoice-payr_qtr,
             inv_amnt    TYPE zuiwc_invoice-inv_amnt,

             belnr       TYPE zuiwc_invoice-belnr,
             corr        TYPE zuiwc_invoice-corr,

             bp          TYPE zuiwc_agency-bp,
             agcy_fund   TYPE zuiwc_agency-agcy_fund,
             agcy_ctr    TYPE zuiwc_agency-agcy_ctr,

             status_msg  TYPE string,
           END OF ty_invoice_work.
    TYPES ty_t_invoice_work TYPE STANDARD TABLE OF ty_invoice_work WITH EMPTY KEY.

    METHODS build_invoice_work
      RETURNING VALUE(rt_work) TYPE ty_t_invoice_work.

    METHODS get_latest_contribution
      IMPORTING
        iv_fund    TYPE zuiwc_gl_config-fund
        iv_agcy    TYPE zuiwc_invoice-agcy
        iv_prctr   TYPE zuiwc_invoice-prctr
        iv_asof    TYPE dats
      EXPORTING
        ev_contr_runid TYPE zuiwc_agcy_amnts-contr_run_id
        ev_contr_date  TYPE zuiwc_invoice-contr_date
        ev_contr_rate  TYPE zuiwc_invoice-contr_rate.

    METHODS apply_overrides
      CHANGING cs_work TYPE ty_invoice_work.

    METHODS calc_payroll_last_quarter
      IMPORTING
        iv_fund    TYPE zuiwc_gl_config-fund
        iv_prctr   TYPE zuiwc_invoice-prctr
        iv_invdate TYPE dats
      RETURNING VALUE(rv_payroll) TYPE zuiwc_invoice-payr_qtr.

    METHODS upsert_invoice_row
      IMPORTING is_work TYPE ty_invoice_work.

    METHODS post_fi_document
      CHANGING cs_work TYPE ty_invoice_work.

    METHODS output_hook
      CHANGING cs_work TYPE ty_invoice_work.

    METHODS display_alv
      IMPORTING it_work TYPE ty_t_invoice_work.

ENDCLASS.


CLASS zcl_uiwc_invoice_runner IMPLEMENTATION.

  METHOD constructor.
    ms_params = is_params.
  ENDMETHOD.

  METHOD execute.

    DATA(lt_work_rows) = build_invoice_work( ).

    LOOP AT lt_work_rows ASSIGNING FIELD-SYMBOL(<ls_work_row>).
      upsert_invoice_row( is_work = <ls_work_row> ).
    ENDLOOP.

    IF ms_params-do_post = abap_true.
      IF ms_params-test_run = abap_true.
        LOOP AT lt_work_rows ASSIGNING <ls_work_row>.
          <ls_work_row>-status_msg = |Test run: FI posting skipped|.
          upsert_invoice_row( is_work = <ls_work_row> ).
        ENDLOOP.
      ELSE.
        LOOP AT lt_work_rows ASSIGNING <ls_work_row>.
          post_fi_document( CHANGING cs_work = <ls_work_row> ).
          upsert_invoice_row( is_work = <ls_work_row> ).
        ENDLOOP.
      ENDIF.
    ENDIF.

    IF ms_params-do_output = abap_true.
      LOOP AT lt_work_rows ASSIGNING <ls_work_row>.
        output_hook( CHANGING cs_work = <ls_work_row> ).
        upsert_invoice_row( is_work = <ls_work_row> ).
      ENDLOOP.
    ENDIF.

    display_alv( lt_work_rows ).

  ENDMETHOD.

  METHOD build_invoice_work.

    "Agencies in scope
    SELECT agcy, prctr, bp, agcy_fund, agcy_ctr, active
      FROM zuiwc_agency
      WHERE active = 'X'
        AND agcy  IN @ms_params-so_agcy
        AND prctr IN @ms_params-so_prctr
      INTO TABLE @DATA(lt_agencies).

    IF lt_agencies IS INITIAL.
      RETURN.
    ENDIF.

    LOOP AT ms_params-so_fund ASSIGNING FIELD-SYMBOL(<ls_fund_rng>) WHERE sign = 'I'.
      LOOP AT lt_agencies ASSIGNING FIELD-SYMBOL(<ls_agency>).

        DATA(ls_work) = VALUE ty_invoice_work(
          inv_id    = ms_params-inv_id
          inv_date  = ms_params-inv_date
          fund      = <ls_fund_rng>-low
          agcy      = <ls_agency>-agcy
          prctr     = <ls_agency>-prctr
          bp        = <ls_agency>-bp
          agcy_fund = <ls_agency>-agcy_fund
          agcy_ctr  = <ls_agency>-agcy_ctr ).

        get_latest_contribution(
          EXPORTING
            iv_fund  = ls_work-fund
            iv_agcy  = ls_work-agcy
            iv_prctr = ls_work-prctr
            iv_asof  = ls_work-inv_date
          IMPORTING
            ev_contr_runid = ls_work-contr_runid
            ev_contr_date  = ls_work-contr_date
            ev_contr_rate  = ls_work-contr_rate ).

        IF ls_work-contr_rate IS INITIAL.
          ls_work-status_msg = |No contribution rate found as of { ls_work-inv_date } for fund { ls_work-fund }|.
          APPEND ls_work TO rt_work.
          CONTINUE.
        ENDIF.

        ls_work-payr_qtr = calc_payroll_last_quarter(
          iv_fund    = ls_work-fund
          iv_prctr   = ls_work-prctr
          iv_invdate = ls_work-inv_date ).

        ls_work-inv_amnt = ls_work-payr_qtr * ls_work-contr_rate.

        apply_overrides( CHANGING cs_work = ls_work ).

        APPEND ls_work TO rt_work.

      ENDLOOP.
    ENDLOOP.

  ENDMETHOD.

  METHOD get_latest_contribution.

    CLEAR: ev_contr_runid, ev_contr_date, ev_contr_rate.

    SELECT contr_run_id, date, contr_rate
      FROM zuiwc_agcy_amnts
      WHERE fund = @iv_fund
        AND agcy = @iv_agcy
        AND prctr = @iv_prctr
        AND date <= @iv_asof
      ORDER BY date DESCENDING
      INTO TABLE @DATA(lt_agcy_rates)
      UP TO 1 ROWS.

    READ TABLE lt_agcy_rates INDEX 1 ASSIGNING FIELD-SYMBOL(<ls_rate>).
    IF sy-subrc = 0.
      ev_contr_runid = <ls_rate>-contr_run_id.
      ev_contr_date  = <ls_rate>-date.
      ev_contr_rate  = <ls_rate>-contr_rate.
    ENDIF.

  ENDMETHOD.

  METHOD apply_overrides.

    SELECT SINGLE contr_rate_ovrd, inv_amnt_ovrd
      FROM zuiwc_agcy_overide
      WHERE agcy         = @cs_work-agcy
        AND prctr        = @cs_work-prctr
        AND contr_run_id = @cs_work-contr_runid
        AND overide_date = @cs_work-inv_date
      INTO @DATA(ls_override).

    IF sy-subrc <> 0.
      RETURN.
    ENDIF.

    IF ls_override-contr_rate_ovrd IS NOT INITIAL.
      cs_work-contr_rate = ls_override-contr_rate_ovrd.
      cs_work-inv_amnt   = cs_work-payr_qtr * cs_work-contr_rate.
    ENDIF.

    IF ls_override-inv_amnt_ovrd IS NOT INITIAL.
      cs_work-inv_amnt = ls_override-inv_amnt_ovrd.
    ENDIF.

  ENDMETHOD.

  METHOD calc_payroll_last_quarter.

    rv_payroll = 0.

    DATA: lv_date_from TYPE dats,
          lv_date_to   TYPE dats.

    lv_date_to = iv_invdate.

    CALL FUNCTION 'RP_CALC_DATE_IN_INTERVAL'
      EXPORTING
        date      = iv_invdate
        months    = -3
        days      = 1
        signum    = '+'
      IMPORTING
        calc_date = lv_date_from
      EXCEPTIONS
        OTHERS    = 1.

    IF sy-subrc <> 0.
      lv_date_from = iv_invdate.
    ENDIF.

    "Payroll GL accounts from ZUIWC_GL_CONFIG
    SELECT saknr
      FROM zuiwc_gl_config
      WHERE fund     = @iv_fund
        AND category = @gc_glcat_payroll
        AND active   = 'X'
      INTO TABLE @DATA(lt_payroll_gl).

    IF lt_payroll_gl IS INITIAL.
      RETURN.
    ENDIF.

    "Sum from ACDOCA using RFUND
    SELECT SUM( hsl ) AS sum_hsl
      FROM acdoca
      WHERE rldnr = @gc_ledger_0l
        AND rrcty = @gc_rrcty_0
        AND racct IN @lt_payroll_gl
        AND prctr = @iv_prctr
        AND rfund = @iv_fund
        AND budat BETWEEN @lv_date_from AND @lv_date_to
      INTO @DATA(lv_sum_hsl).

    rv_payroll = COALESCE( lv_sum_hsl, 0 ).

  ENDMETHOD.

  METHOD upsert_invoice_row.

    "Key assumed: INV_ID + INV_DATE + AGCY + PRCTR
    MODIFY zuiwc_invoice FROM VALUE zuiwc_invoice(
      inv_id     = is_work-inv_id
      inv_date   = is_work-inv_date
      agcy       = is_work-agcy
      prctr      = is_work-prctr
      contr_rate = is_work-contr_rate
      contr_date = is_work-contr_date
      payr_qtr   = is_work-payr_qtr
      inv_amnt   = is_work-inv_amnt
      belnr      = is_work-belnr
      corr       = is_work-corr ).

    IF sy-subrc <> 0.
      INSERT zuiwc_invoice FROM VALUE zuiwc_invoice(
        inv_id     = is_work-inv_id
        inv_date   = is_work-inv_date
        agcy       = is_work-agcy
        prctr      = is_work-prctr
        contr_rate = is_work-contr_rate
        contr_date = is_work-contr_date
        payr_qtr   = is_work-payr_qtr
        inv_amnt   = is_work-inv_amnt
        belnr      = is_work-belnr
        corr       = is_work-corr ).
    ENDIF.

  ENDMETHOD.

  METHOD post_fi_document.

    IF cs_work-belnr IS NOT INITIAL.
      RETURN.
    ENDIF.

    DATA(lv_bukrs) = CONV bukrs( 'ZZZ' ). "hardcoded per your earlier decision

    SELECT SINGLE waers FROM t001 WHERE bukrs = @lv_bukrs INTO @DATA(lv_waers).
    IF sy-subrc <> 0 OR lv_waers IS INITIAL.
      lv_waers = 'USD'.
    ENDIF.

    SELECT SINGLE rev_gl FROM zuiwc_config INTO @DATA(lv_rev_gl).
    IF sy-subrc <> 0 OR lv_rev_gl IS INITIAL.
      cs_work-status_msg = |Missing REV_GL in ZUIWC_CONFIG|.
      RETURN.
    ENDIF.

    DATA: ls_doc_header TYPE bapiache09,
          lt_ar_items   TYPE STANDARD TABLE OF bapiacar09,
          lt_gl_items   TYPE STANDARD TABLE OF bapiacgl09,
          lt_amounts    TYPE STANDARD TABLE OF bapiaccr09,
          lt_return     TYPE STANDARD TABLE OF bapiret2.

    ls_doc_header-username   = sy-uname.
    ls_doc_header-comp_code  = lv_bukrs.
    ls_doc_header-doc_type   = gc_doctype_dr.
    ls_doc_header-doc_date   = ms_params-inv_date.
    ls_doc_header-pstng_date = ms_params-inv_date.
    ls_doc_header-ref_doc_no = cs_work-agcy.
    ls_doc_header-header_txt = |{ ms_params-inv_id } { ms_params-inv_date }|.

    CONSTANTS: lc_item_ar TYPE bapiacar09-itemno_acc VALUE 1,
               lc_item_gl TYPE bapiacgl09-itemno_acc VALUE 2.

    APPEND VALUE bapiacar09(
      itemno_acc = lc_item_ar
      customer   = cs_work-bp
      alloc_nmbr = cs_work-agcy
      item_text  = |Pooled Insurance Billing for { ms_params-inv_date }|
      ref_key_1  = |{ cs_work-contr_rate }| ) TO lt_ar_items.

    APPEND VALUE bapiacgl09(
      itemno_acc = lc_item_gl
      gl_account = lv_rev_gl
      item_text  = |Pooled Insurance Billing for { ms_params-inv_date }|
      fund       = cs_work-agcy_fund
      costcenter = cs_work-agcy_ctr ) TO lt_gl_items.

    APPEND VALUE bapiaccr09(
      itemno_acc = lc_item_ar
      currency   = lv_waers
      amt_doccur = cs_work-inv_amnt ) TO lt_amounts.

    APPEND VALUE bapiaccr09(
      itemno_acc = lc_item_gl
      currency   = lv_waers
      amt_doccur = - cs_work-inv_amnt ) TO lt_amounts.

    CALL FUNCTION 'BAPI_ACC_DOCUMENT_POST'
      EXPORTING
        documentheader    = ls_doc_header
      TABLES
        accountreceivable = lt_ar_items
        accountgl         = lt_gl_items
        currencyamount    = lt_amounts
        return            = lt_return.

    READ TABLE lt_return WITH KEY type = 'E' ASSIGNING FIELD-SYMBOL(<ls_ret_err>).
    IF sy-subrc = 0.
      cs_work-status_msg = |FI post failed: { <ls_ret_err>-message }|.
      RETURN.
    ENDIF.

    CALL FUNCTION 'BAPI_TRANSACTION_COMMIT'
      EXPORTING
        wait = abap_true.

    "BELNR: best-effort from return messages
    DATA(lv_belnr_found) = VALUE belnr_d( ).
    LOOP AT lt_return ASSIGNING FIELD-SYMBOL(<ls_ret>).
      IF <ls_ret>-message_v2 IS NOT INITIAL AND strlen( <ls_ret>-message_v2 ) >= 10.
        lv_belnr_found = <ls_ret>-message_v2(10).
        EXIT.
      ENDIF.
    ENDLOOP.

    cs_work-belnr = lv_belnr_found.
    cs_work-status_msg = COND string(
      WHEN cs_work-belnr IS INITIAL THEN |FI posted (BELNR not derived from return)|
      ELSE |FI posted: { cs_work-belnr }| ).

  ENDMETHOD.

  METHOD output_hook.
    IF ms_params-test_run = abap_true.
      cs_work-status_msg = |Test run: output skipped|.
      RETURN.
    ENDIF.

    "ZINVC integration deferred
    cs_work-corr = 'X'.
    IF cs_work-status_msg IS INITIAL.
      cs_work-status_msg = |Output hook set (ZINVC integration pending)|.
    ELSE.
      cs_work-status_msg = cs_work-status_msg && |; Output hook set|.
    ENDIF.
  ENDMETHOD.

  METHOD display_alv.
    TRY.
        cl_salv_table=>factory(
          IMPORTING r_salv_table = DATA(lo_alv)
          CHANGING  t_table      = it_work ).

        lo_alv->get_functions( )->set_all( abap_true ).
        lo_alv->display( ).
      CATCH cx_salv_msg.
        LOOP AT it_work ASSIGNING FIELD-SYMBOL(<ls_row>).
          WRITE: / <ls_row>-fund, <ls_row>-agcy, <ls_row>-prctr,
                   <ls_row>-inv_amnt, <ls_row>-belnr, <ls_row>-corr, <ls_row>-status_msg.
        ENDLOOP.
    ENDTRY.
  ENDMETHOD.

ENDCLASS.
